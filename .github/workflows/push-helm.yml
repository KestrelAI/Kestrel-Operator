name: Package and Push Helm Chart

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      chart_version:
        description: 'Chart version to package and push (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
        type: string
      chart_name:
        description: 'Chart name (kestrel-operator or kestrel-operator-onprem)'
        required: false
        default: 'kestrel-operator'
        type: string

env:
  REGISTRY: ghcr.io
  
jobs:
  package-and-push:
    name: Package and Push Helm Chart
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'

    - name: Log in to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Update chart name, version, and image repository
      run: |
        CHART_NAME="${{ github.event.inputs.chart_name || 'kestrel-operator' }}"
        CHART_VERSION="${{ github.event.inputs.chart_version || '0.1.0' }}"
        # Update Chart.yaml
        sed -i "s/^name:.*/name: $CHART_NAME/" helm/kestrel-operator/Chart.yaml
        sed -i "s/^version:.*/version: $CHART_VERSION/" helm/kestrel-operator/Chart.yaml
        # Update values.yaml image repository to match chart name
        sed -i "s|repository: ghcr.io/kestrelai/kestrel-operator|repository: ghcr.io/kestrelai/$CHART_NAME|" helm/kestrel-operator/values.yaml

    - name: Package Helm chart
      run: |
        helm package helm/kestrel-operator --destination .

    - name: Push Helm chart to GHCR
      run: |
        CHART_NAME="${{ github.event.inputs.chart_name || 'kestrel-operator' }}"
        CHART_VERSION="${{ github.event.inputs.chart_version || '0.1.0' }}"
        REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        helm push ${CHART_NAME}-${CHART_VERSION}.tgz oci://${{ env.REGISTRY }}/${REPO_OWNER}/charts