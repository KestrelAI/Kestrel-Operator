name: Package and Push Helm Chart

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      chart_version:
        description: 'Chart version to package and push (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
        type: string

env:
  REGISTRY: ghcr.io
  
jobs:
  package-and-push:
    name: Package and Push Helm Chart
    runs-on: blacksmith-4vcpu-ubuntu-2404
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'

    - name: Log in to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Update chart version
      run: |
        CHART_VERSION="${{ github.event.inputs.chart_version || '0.1.0' }}"
        sed -i "s/^version:.*/version: $CHART_VERSION/" helm/kestrel-operator/Chart.yaml

    - name: Package Helm chart
      run: |
        helm package helm/kestrel-operator --destination .

    - name: Push Helm chart to GHCR
      run: |
        CHART_VERSION="${{ github.event.inputs.chart_version || '0.1.0' }}"
        REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        helm push kestrel-operator-$CHART_VERSION.tgz oci://${{ env.REGISTRY }}/${REPO_OWNER}/charts